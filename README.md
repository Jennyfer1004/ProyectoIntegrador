MONTAJE DE LA BASE DE DATOS EN ORACLE 

1- Crear el usuario DBA

CREATE USER stylebiker IDENTIFIED BY stylebiker;
GRANT dba to stylebiker;
conn stylebiker/stylebiker;
Dentro del usuario DBA crear los otros 3 usuarios con sus respectivos roles

CREAR ROLES

CREATE ROLE administrador;

GRANT SELECT ON cliente TO administrador;
GRANT SELECT ON producto TO administrador;
GRANT SELECT ON proveedor TO administrador;
GRANT SELECT ON factura TO administrador;
GRANT SELECT ON empleado TO administrador;
GRANT SELECT ON producto_factura TO administrador;
GRANT EXECUTE ON stylebiker.insertarCliente TO administrador;
GRANT EXECUTE ON stylebiker.modificarCliente TO administrador;
GRANT EXECUTE ON stylebiker.ins_proveedor TO administrador;
GRANT EXECUTE ON stylebiker.MOD_PROVEEDOR TO administrador;
GRANT EXECUTE ON stylebiker.ins_empleado TO administrador;
GRANT EXECUTE ON stylebiker.MOD_EMPLEADO TO administrador;
GRANT EXECUTE ON stylebiker.eliminarCliente TO administrador;
GRANT EXECUTE ON stylebiker.elim_proveedor TO administrador;
GRANT EXECUTE ON stylebiker.elim_empleado TO administrador;
GRANT EXECUTE ON stylebiker.insertar_producto TO administrador;
GRANT EXECUTE ON stylebiker.elim_producto TO administrador;
GRANT EXECUTE ON stylebiker.MOD_PRODUCTO TO administrador;
GRANT EXECUTE ON stylebiker.fun_id_proveedor TO administrador;












CREATE USER admint IDENTIFIED BY admint;

GRANT administrador TO admint;

GRANT CREATE SESSION TO admint;

conn admint/admint;

SELECT * FROM biker.cliente;

CREATE ROLE gerente1;

GRANT SELECT ON producto TO gerente1;
GRANT SELECT ON proveedor TO gerente1;
GRANT SELECT ON factura TO gerente1;
GRANT SELECT ON empleado TO gerente1;

CREATE USER manager IDENTIFIED BY manager;

GRANT gerente1 TO manager;

GRANT CREATE SESSION TO manager;

conn manager/manager;

SELECT * FROM biker.cliente;

CREATE ROLE vendedor;

GRANT SELECT ON cliente TO vendedor;
GRANT SELECT ON producto TO vendedor;
GRANT SELECT ON factura TO vendedor;
GRANT EXECUTE ON stylebiker.insertarCliente TO vendedor;
GRANT EXECUTE ON stylebiker.modificarCliente TO vendedor;
GRANT EXECUTE ON stylebiker.eliminarCliente TO vendedor;



CREATE USER seller IDENTIFIED BY seller;

GRANT vendedor TO seller;

GRANT CREATE SESSION TO seller;

conn seller/seller;

SELECT * FROM stylebiker.cliente;

2- Crear las tablas

USUARIOS:

CREATE TABLE usuario
(id VARCHAR(20) CONSTRAINT id_usu_pk PRIMARY KEY,
usuario_dado VARCHAR(50) CONSTRAINT usu_usu_nn NOT NULL,
contrasena VARCHAR(50) CONSTRAINT con_usu_nn NOT NULL,
rol VARCHAR(50) CONSTRAINT rol_usu_nn NOT NULL);


INSERT INTO usuario (usuario_dado, contrasena, rol) 
VALUES ( 'admin', 'admin', 'administrador');

INSERT INTO usuario (usuario_dado, contrasena, rol) 
VALUES ('gerente', 'gerente', 'gerente');

INSERT INTO usuario (usuario_dado, contrasena, rol)
VALUES ('vendedor', 'vendedor', 'vendedor');


CLIENTES:

CREATE TABLE Cliente 
(cedula VARCHAR(20) CONSTRAINT cli_ced_pk PRIMARY KEY,
nombre_completo VARCHAR(50) CONSTRAINT cli_nom_nn NOT NULL,
correo VARCHAR(20) CONSTRAINT cli_cor_nn NOT NULL,
telefono VARCHAR(20) CONSTRAINT cli_tel_nn NOT NULL,
direccion VARCHAR(30),
estado VARCHAR(20) CONSTRAINT cli_est_nn NOT NULL);

INSERTS PARA CLIENTES

INSERT INTO Cliente (cedula, nombre_completo, correo, telefono, direccion, estado)
VALUES ('1234567890', 'Juan Pérez', 'juan@example.com', '123456789', 'Calle Principal 123', 'Activo');

INSERT INTO Cliente (cedula, nombre_completo, correo, telefono, direccion, estado)
VALUES ('0987654321', 'María García', 'maria@example.com', '987654321', 'Avenida Central 456', 'Inactivo');

INSERT INTO Cliente (cedula, nombre_completo, correo, telefono, direccion, estado)
VALUES ('2468013579', 'Luis Martínez', 'luis@example.com', '246801357', 'Plaza Principal 789', 'Activo');






PROVEEDOR:


CREATE TABLE Proveedor 
(id VARCHAR(15) CONSTRAINT pro_id_pk  PRIMARY KEY,
nombre_empresa VARCHAR(50)CONSTRAINT pro_nomemp_nn NOT NULL,
direccion VARCHAR(50) CONSTRAINT pro_dir_nn NOT NULL,
telefono VARCHAR(20)CONSTRAINT pro_tel_nn NOT NULL,
correo VARCHAR(50)CONSTRAINT pro_cor_nn NOT NULL,
productos_suministrados VARCHAR(50)CONSTRAINT pro_prosum_nn NOT NULL,
estado VARCHAR(20) CONSTRAINT emp_est_nn NOT NULL);

INSERTS PARA PROVEEDOR

INSERT INTO Proveedor (id, nombre_empresa, direccion, telefono, correo, productos_suministrados, estado)
VALUES ('PROV001', 'Proveedor A', 'Calle Principal 123', '123456789', 'proveedora@example.com', 'Producto A', 'Activo');

INSERT INTO Proveedor (nombre_empresa, direccion, telefono, correo, productos_suministrados, estado)
VALUES ( 'Proveedor B', 'Avenida Central 456', '987654321', 'proveedorb@example.com', 'Producto B', 'Inactivo');

INSERT INTO Proveedor ( nombre_empresa, direccion, telefono, correo, productos_suministrados, estado)
VALUES ('Proveedor C', 'Plaza Principal 789', '246801357', 'proveedorc@example.com', 'Producto C', 'Activo');


PRODUCTOS:

CREATE TABLE Producto 
(codigo VARCHAR(15) CONSTRAINT prod_id_pk PRIMARY KEY,
nombre VARCHAR(50) CONSTRAINT prod_nom_nn NOT NULL,
descripcion VARCHAR(100) CONSTRAINT prod_desc_nn NOT NULL,
valor_compra VARCHAR(20) CONSTRAINT prod_valcom_nn NOT NULL,
cantidad_stock VARCHAR(50) CONSTRAINT prod_cansto_nn NOT NULL,
estado VARCHAR(20) CONSTRAINT pro_est_nn NOT NULL,
id_proveedor VARCHAR(15) NOT NULL, 
CONSTRAINT prod_id_fk FOREIGN KEY (id_proveedor) REFERENCES proveedor(id));





INSERTS PARA PRODUCTOS

INSERT INTO Producto (codigo, nombre, descripcion, valor_compra, cantidad_stock,estado, id_proveedor)
VALUES ('PROD001', 'Producto A', 'Descripción del Producto A', '100', '50','inactivo','1');

INSERT INTO Producto (codigo, nombre, descripcion, valor_compra, cantidad_stock, estado, id_proveedor)
VALUES ('PROD002', 'Producto B', 'Descripción del Producto B', '150', '30','inactivo', '2');

INSERT INTO Producto (codigo, nombre, descripcion, valor_compra, cantidad_stock, estado, id_proveedor)
VALUES ('PROD003', 'Producto C', 'Descripción del Producto C', '200', '20','inactivo','3');


FACTURA:

CREATE TABLE Factura 
(codigo_factura VARCHAR(30) CONSTRAINT FAC_COD_PK PRIMARY KEY,
fecha_realizada DATE CONSTRAINT fac_fech_nn NOT NULL,
estado VARCHAR(20) CONSTRAINT fac_est_nn NOT NULL,
cedula_cliente VARCHAR(20) NOT NULL ,
CONSTRAINT fac_cedcli_fk  FOREIGN KEY (cedula_cliente) REFERENCES cliente(cedula),
ced_empleado VARCHAR(20) NOT NULL,
CONSTRAINT fac_cedemp_fk FOREIGN KEY (ced_empleado) REFERENCES empleado(cedula));

INSERTS PARA FACTURA

INSERT INTO Factura (estado, cedula_cliente,ced_empleado)
VALUES ('Activo', '1234567890','1111111111');

INSERT INTO Factura (estado, cedula_cliente,ced_empleado)
VALUES ('Activo', '0987654321','1111111111');


INSERT INTO Factura (estado, cedula_cliente,ced_empleado)
VALUES ('Activo', '2468013579','1111111111');









EMPLEADO:

CREATE TABLE empleado
(cedula VARCHAR(20) CONSTRAINT emp_ced_pk PRIMARY KEY,
nombre_completo VARCHAR(50) CONSTRAINT emp_nom_nn NOT NULL,
direccion VARCHAR(30) CONSTRAINT emp_dir_nn NOT NULL,
correo VARCHAR(20) CONSTRAINT emp_cor_nn NOT NULL,
telefono VARCHAR(20) CONSTRAINT emp_tel_nn NOT NULL,
estado VARCHAR(20) CONSTRAINT empl_est_nn NOT NULL);

INSERTS PARA EMPLEADO

INSERT INTO Empleado (cedula, nombre_completo, direccion, correo, telefono, estado)
VALUES ('1111111111', 'Carlos González', 'Calle Alegre 123', 'carlos@example.com', '111111111', 'Activo');

INSERT INTO Empleado (cedula, nombre_completo, direccion, correo, telefono, estado)
VALUES ('2222222222', 'Laura Martínez', 'Avenida del Sol 456', 'laura@example.com', '222222222', 'Activo');

INSERT INTO Empleado (cedula, nombre_completo, direccion, correo, telefono, estado)
VALUES ('3333333333', 'Andrés Rodríguez', 'Plaza Principal 789', 'andres@example.com', '333333333', 'Inactivo');


PRODUCTO_FACTURA

CREATE TABLE producto_factura
(id VARCHAR(20) CONSTRAINT id_profac_pk PRIMARY KEY,
canproductos_comprados VARCHAR(50) CONSTRAINT profac_procom_nn NOT NULL,
valor_por_unidad VARCHAR(50) CONSTRAINT profac_valuni_nn NOT NULL, 
codigo_factura VARCHAR(20) NOT NULL,
CONSTRAINT profac_codfac_fk FOREIGN KEY (codigo_factura)REFERENCES factura(codigo_factura),
codigo_producto VARCHAR(15) NOT NULL,
CONSTRAINT profac_codpro_fk FOREIGN KEY (codigo_producto) REFERENCES producto(codigo));

INSERTS PARA PRODUCTO-FACTURA

INSERT INTO producto_factura (canproductos_comprados, valor_por_unidad, codigo_factura, codigo_producto)
VALUES ( '5', '100', '10005', 'PROD001');

INSERT INTO producto_factura (canproductos_comprados, valor_por_unidad, codigo_factura, codigo_producto)
VALUES ('3', '150', '10005', 'PROD002');

PROCEDIMIENTOS Y FUNCIONES

CRUD CLIENTES

PROCEDIMIENTO DE INSERTAR CLIENTE

CREATE OR REPLACE PROCEDURE insertarCliente
(p_cedula IN varchar2,
p_nombre_completo IN varchar2,
p_correo IN varchar2,
p_telefono IN varchar2,
p_direccion IN varchar2,
p_estado IN varchar2)
IS
BEGIN
INSERT INTO cliente (cedula, nombre_completo, correo, telefono, direccion, estado)
VALUES (p_cedula, p_nombre_completo, p_correo, p_telefono, p_direccion, p_estado);
COMMIT;
EXCEPTION
WHEN OTHERS THEN
DBMS_OUTPUT.PUT_LINE('error:'|| SQLERRM);
END INSERTARCLIENTE;
/

PROCEDIMIENTO PARA EDITAR UN CLIENTE


CREATE OR REPLACE PROCEDURE modificarCliente
(p_nombre_completo IN varchar2,
p_correo IN varchar2,
p_telefono IN varchar2,
p_direccion IN varchar2,
p_cedula IN VARCHAR2)
IS
BEGIN
UPDATE cliente
SET NOMBRE_COMPLETO = P_NOMBRE_COMPLETO,
CORREO = P_CORREO,
TELEFONO = P_TELEFONO,
DIRECCION = P_DIRECCION
WHERE CEDULA = P_CEDULA;
COMMIT;
EXCEPTION 
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL EDITAR CLIENTE :'|| SQLERRM);
END MODIFICARCLIENTE;
/


PROCEDIMIENTO PARA ELIMINAR UN CLIENTE

CREATE OR REPLACE PROCEDURE eliminarCliente(
p_cedula IN varchar2,
p_estado IN varchar2)
is
BEGIN 
UPDATE cliente
SET estado = p_estado
WHERE cedula = p_cedula;

COMMIT;
EXCEPTION
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('error al eliminar cliente: ' || sqlerrm);
end eliminarcliente;
/

SENTENCIA PARA BUSCAR TODOS LOS REGISTROS DE LOS CLIENTES

SELECT * FROM stylebiker.cliente;

SENTENCIA PARA BUSCAR UN CLIENTE POR SU CEDULA O POR SU NOMBRE

SELECT * FROM stylebiker.cliente WHERE UPPER(cedula) LIKE UPPER(? || '%') OR  UPPER(nombre_completo) LIKE UPPER(? || '%')");







2.1.  Procedimiento para insertar datos en la tabla proveedor:

CREATE OR REPLACE PROCEDURE INS_PROVEEDOR
(P_NOMBRE_EMPRESA IN VARCHAR2,
P_DIRECCION IN VARCHAR2,
P_TELEFONO IN VARCHAR2,
P_CORREO IN VARCHAR2,
P_PRODUCTOS_SUMINISTRADOS IN VARCHAR2,
P_ESTADO IN VARCHAR2
)
IS
BEGIN
INSERT INTO PROVEEDOR (NOMBRE_EMPRESA,DIRECCION,TELEFONO,CORREO,PRODUCTOS_SUMINISTRADOS,ESTADO)
VALUES (P_NOMBRE_EMPRESA,P_DIRECCION,P_TELEFONO,P_CORREO,P_PRODUCTOS_SUMINISTRADOS,P_ESTADO);
COMMIT;
EXCEPTION
WHEN OTHERS THEN
DBMS_OUTPUT.PUT_LINE('ERROR AL INSERTAR PROVEEDOR:'|| SQLERRM);
END INS_PROVEEDOR;
/

2.2.  Procedimiento para eliminar proveedor:


CREATE OR REPLACE PROCEDURE ELIM_PROVEEDOR(
P_NOMBRE_EMPRESA IN VARCHAR2,
P_ESTADO IN VARCHAR2)
IS
BEGIN 
UPDATE PROVEEDOR
SET ESTADO = P_ESTADO
WHERE UPPER(NOMBRE_EMPRESA) = UPPER(P_NOMBRE_EMPRESA);
COMMIT;
EXCEPTION
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL ELIMINAR PROVEEDOR: ' || SQLERRM);
END ELIM_PROVEEDOR;
/


2.3.  Procedimiento para editar proveedor:

CREATE OR REPLACE PROCEDURE MOD_PROVEEDOR(
P_NOMBRE_EMPRESA IN VARCHAR2,
P_DIRECCION IN VARCHAR2,
P_TELEFONO IN VARCHAR2,
P_CORREO IN VARCHAR2,
P_PRODUCTOS_SUMINISTRADOS IN VARCHAR2)
IS
BEGIN
UPDATE PROVEEDOR
SET NOMBRE_EMPRESA = P_NOMBRE_EMPRESA,
DIRECCION = P_DIRECCION,
TELEFONO = P_TELEFONO,
CORREO = P_CORREO,
PRODUCTOS_SUMINISTRADOS = P_PRODUCTOS_SUMINISTRADOS
WHERE UPPER(NOMBRE_EMPRESA) = UPPER(P_NOMBRE_EMPRESA);
COMMIT;
EXCEPTION 
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL EDITAR PROVEEDOR :'|| SQLERRM);
END MOD_PROVEEDOR;
/

2.4.  Función para buscar proveedor:

CREATE OR REPLACE FUNCTION BUSCAR_PROVEEDOR(
    P_NOMBREEMPRESA IN PROVEEDOR.NOMBRE_EMPRESA%TYPE
   ) 
RETURN VARCHAR2
IS
    CURSOR C_PROVEEDOR IS 
        SELECT *
        FROM PROVEEDOR
        WHERE UPPER(NOMBRE_EMPRESA) = UPPER(P_NOMBREEMPRESA);

    V_MENSAJE VARCHAR2(4000) := 'PROVEEDORES ENCONTRADOS: ';
BEGIN
    FOR R_PROVEEDOR IN C_PROVEEDOR LOOP
        V_MENSAJE := V_MENSAJE || 'NOMBRE_EMPRESA: ' || R_PROVEEDOR.NOMBRE_EMPRESA || ', DIRECCION: ' || R_PROVEEDOR.DIRECCION || ', TELEFONO: ' || R_PROVEEDOR.TELEFONO || ', CORREO: ' || R_PROVEEDOR.CORREO || ', PRODUCTOS_SUMINISTRADOS: ' || R_PROVEEDOR.PRODUCTOS_SUMINISTRADOS || ', ESTADO: ' || R_PROVEEDOR.ESTADO || CHR(10);
    END LOOP;
    
    RETURN V_MENSAJE;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR AL BUSCAR PROVEEDOR: ' || SQLERRM);
        RETURN 'ERROR AL BUSCAR PROVEEDOR.';
END BUSCAR_PROVEEDOR;
/

3.1.  Procedimiento para insertar datos en la tabla empleado:
CREATE OR REPLACE PROCEDURE INS_EMPLEADO
(P_CEDULA IN VARCHAR2,
P_NOMBRE_COMPLETO IN VARCHAR2,
P_DIRECCION IN VARCHAR2,
P_CORREO IN VARCHAR2,
P_TELEFONO IN VARCHAR2,
P_ESTADO IN VARCHAR2
)
IS
BEGIN
INSERT INTO EMPLEADO (CEDULA,NOMBRE_COMPLETO,DIRECCION,CORREO,TELEFONO,ESTADO)
VALUES (P_CEDULA,P_NOMBRE_COMPLETO,P_DIRECCION,P_CORREO,P_TELEFONO,P_ESTADO);
COMMIT;
EXCEPTION
WHEN OTHERS THEN
DBMS_OUTPUT.PUT_LINE('ERROR:'|| SQLERRM);
END INS_EMPLEADO;
/


3.2.  Procedimiento para eliminar empleado:

CREATE OR REPLACE PROCEDURE ELIM_EMPLEADO(
P_CEDULA IN VARCHAR2,
P_ESTADO IN VARCHAR2)
IS
BEGIN 
UPDATE EMPLEADO
SET ESTADO = P_ESTADO
WHERE CEDULA = P_CEDULA;
COMMIT;
EXCEPTION
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL ELIMINAR EMPLEADO: ' || SQLERRM);
END ELIM_EMPLEADO;
/

3.3.  Procedimiento para editar  empleado:
CREATE OR REPLACE PROCEDURE MOD_EMPLEADO(
P_CEDULA IN VARCHAR2,
P_NOMBRE_COMPLETO IN VARCHAR2,
P_DIRECCION IN VARCHAR2,
P_CORREO IN VARCHAR2,
P_TELEFONO IN VARCHAR2)
IS
BEGIN
UPDATE EMPLEADO
SET
NOMBRE_COMPLETO = P_NOMBRE_COMPLETO,
DIRECCION = P_DIRECCION,
CORREO = P_CORREO,
TELEFONO = P_TELEFONO
WHERE UPPER(CEDULA) = UPPER(P_CEDULA);
COMMIT;
EXCEPTION 
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL EDITAR EMPLEADO :'|| SQLERRM);
END MOD_EMPLEADO;
/

3.4.  Funcion para buscar  empleado:

CREATE OR REPLACE FUNCTION BUSCAR_EMPLEADO(
    P_CEDULA IN EMPLEADO.CEDULA%TYPE,
    P_NOMBRE IN EMPLEADO.NOMBRE_COMPLETO%TYPE
) 
RETURN VARCHAR2
IS
    CURSOR C_EMPLEADO IS 
        SELECT *
        FROM EMPLEADO
        WHERE UPPER(CEDULA) = UPPER(P_CEDULA) OR UPPER(NOMBRE_COMPLETO) = UPPER(P_NOMBRE);

    V_MENSAJE VARCHAR2(4000) := 'EMPLEADOS ENCONTRADOS: ';
BEGIN
    FOR R_EMPLEADO IN C_EMPLEADO LOOP
        V_MENSAJE := V_MENSAJE || 'CEDULA: ' || R_EMPLEADO.CEDULA || ', NOMBRE_COMPLETO: ' || R_EMPLEADO.NOMBRE_COMPLETO || ', DIRECCION: ' || R_EMPLEADO.DIRECCION || ', CORREO: ' || R_EMPLEADO.CORREO || ', TELEFONO: ' || R_EMPLEADO.TELEFONO || ', ESTADO: ' || R_EMPLEADO.ESTADO || CHR(10);
    END LOOP;
    
    RETURN V_MENSAJE;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR AL BUSCAR EMPLEADO: ' || SQLERRM);
        RETURN 'ERROR AL BUSCAR EMPLEADO.';
END BUSCAR_EMPLEADO;
/




4.1.Procedimiento y función para insertar un nuevo producto:

CREATE OR REPLACE FUNCTION FUN_ID_PROVEEDOR(
F_NOMBRE PROVEEDOR.NOMBRE_EMPRESA%TYPE
)
RETURN NUMBER
IS
V_ID PROVEEDOR.ID%TYPE;
BEGIN
SELECT ID INTO V_ID
FROM PROVEEDOR
WHERE UPPER(NOMBRE_EMPRESA) = UPPER(F_NOMBRE);
RETURN V_ID;
EXCEPTION 
WHEN OTHERS THEN
DBMS_OUTPUT.PUT_LINE('ERROR AL BUSCAR PROVEEDOR :'|| SQLERRM);
END FUN_ID_PROVEEDOR;
/




CREATE OR REPLACE PROCEDURE INSERTAR_PRODUCTO(
    P_CODIGO IN VARCHAR2,
    P_NOMBRE IN VARCHAR2,
    P_DESCRIPCION IN VARCHAR2,
    P_VALOR_COMPRA IN VARCHAR2,
    P_CANTIDAD_STOCK IN VARCHAR2,
    P_ESTADO IN VARCHAR2
) IS
    V_ID_PROVEEDOR NUMBER;
BEGIN
      V_ID_PROVEEDOR := FUN_ID_PROVEEDOR(P_NOMBRE);

    INSERT INTO PRODUCTO (CODIGO, NOMBRE, DESCRIPCION, VALOR_COMPRA, CANTIDAD_STOCK, ID_PROVEEDOR, ESTADO)
    VALUES (P_CODIGO, P_NOMBRE, P_DESCRIPCION, P_VALOR_COMPRA, P_CANTIDAD_STOCK, V_ID_PROVEEDOR, P_ESTADO);

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR AL INSERTAR PRODUCTO :' || SQLERRM);
END INSERTAR_PRODUCTO;
/


4.1.Procedimiento para eliminar un producto:
CREATE OR REPLACE PROCEDURE ELIM_PRODUCTO(
P_NOMBRE IN VARCHAR2,
P_ESTADO IN VARCHAR2)
IS
BEGIN 
UPDATE PRODUCTO
SET ESTADO = P_ESTADO
WHERE UPPER (NOMBRE) = UPPER(P_NOMBRE);

COMMIT;
EXCEPTION
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL ELIMINAR PRODUCTO: ' || SQLERRM);
END ELIM_PRODUCTO;
/

4.1.Procedimiento para editar un producto:
CREATE OR REPLACE PROCEDURE MOD_PRODUCTO(
P_NOMBRE IN VARCHAR2,
P_DESCRIPCION IN VARCHAR2,
P_VALOR_COMPRA IN VARCHAR2,
P_CANTIDAD_EN_STOCK IN VARCHAR2
)
IS
BEGIN
UPDATE PRODUCTO
SET NOMBRE = P_NOMBRE,
DESCRIPCION = P_DESCRIPCION,
VALOR_COMPRA = P_VALOR_COMPRA,
CANTIDAD_STOCK = P_CANTIDAD_EN_STOCK
WHERE UPPER(NOMBRE)= UPPER(P_NOMBRE);
COMMIT;
EXCEPTION 
WHEN OTHERS THEN 
DBMS_OUTPUT.PUT_LINE('ERROR AL EDITAR PRODUCTO :'|| SQLERRM);
END MOD_PRODUCTO;
/

4.1.Función para buscar un producto:
CREATE OR REPLACE FUNCTION BUSCAR_PRODUCTO(
    P_CODIGO IN PRODUCTO.CODIGO%TYPE,
    P_NOMBRE IN PRODUCTO.NOMBRE%TYPE
) 
RETURN VARCHAR2
IS
    CURSOR C_PRODUCTO IS 
        SELECT *
        FROM PRODUCTO
        WHERE UPPER(CODIGO) = UPPER(P_CODIGO) OR UPPER(NOMBRE) = UPPER(P_NOMBRE);

    V_MENSAJE VARCHAR2(4000) := 'PRODUCTOS ENCONTRADOS: ';
BEGIN
    FOR R_PRODUCTO IN C_PRODUCTO LOOP
        V_MENSAJE := V_MENSAJE || 'CÓDIGO: ' || R_PRODUCTO.CODIGO || ', NOMBRE: ' || R_PRODUCTO.NOMBRE || ', DESCRIPCIÓN: ' || R_PRODUCTO.DESCRIPCION || ', VALOR DE COMPRA: ' || R_PRODUCTO.VALOR_COMPRA || ', CANTIDAD EN STOCK: ' || R_PRODUCTO.CANTIDAD_STOCK || ', ID PROVEEDOR: ' || R_PRODUCTO.ID_PROVEEDOR || ', ESTADO: ' || R_PRODUCTO.ESTADO || CHR(10);
    END LOOP;
    
    RETURN V_MENSAJE;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR AL BUSCAR PRODUCTO: ' || SQLERRM);
        RETURN 'ERROR AL BUSCAR PRODUCTO.';
END BUSCAR_PRODUCTO;
/



FUNCION PARA ALERTAR EL ESTADO DE STOCK


CREATE OR REPLACE  FUNCTION FUN_ALERTASTOCK
RETURN BOOLEAN 
IS
ESTADO_STOCK NUMBER;
CONSTOCK BOOLEAN := FALSE;
BEGIN
SELECT MAX(CANTIDAD_STOCK) INTO ESTADO_STOCK
FROM PRODUCTO
WHERE CANTIDAD_STOCK <=5;

IF ESTADO_STOCK IS NOT NULL THEN 
CONSTOCK := TRUE;
END IF;

RETURN CONSTOCK;

END FUN_ALERTASTOCK;
/


SECUENCIAS:

 secuencia para el id proveedor:
CREATE SEQUENCE sequence_proveedor
START WITH 1
 INCREMENT BY 1;

secuencia para el id producto_factura:
CREATE SEQUENCE SEQUENCE_PRODUCTO_FACTURA
START WITH 1000
INCREMENT BY 1;

 secuencia para el id factura:
FACTURA:
CREATE SEQUENCE SEQUENCE_FACTURA
START WITH 10000
INCREMENT BY 1;

Secuencia para el id usuario:
USUARIO:
CREATE SEQUENCE SEQUENCE_USUARIO
START WITH 1000000
INCREMENT BY 1;


DISPARADORES:

 Disparador para el id incremental de la tabla  proveedor:

 CREATE OR REPLACE TRIGGER TRIGGER_PROVEEDOR
    BEFORE INSERT ON PROVEEDOR
    FOR EACH ROW
    BEGIN
    SELECT SEQUENCE_PROVEEDOR.NEXTVAL INTO :NEW.ID FROM DUAL;
    END;
    /

 Disparador para el id incremental de la tabla producto_factura:
CREATE OR REPLACE TRIGGER TRIGGER_PRODUCTO_FACTURA
    BEFORE INSERT ON PRODUCTO_FACTURA
    FOR EACH ROW
    BEGIN
    SELECT SEQUENCE_PRODUCTO_FACTURA.NEXTVAL INTO :NEW.ID FROM DUAL;
    END;
    /


 Disparador para el id incremental de la tabla factura:

CREATE OR REPLACE TRIGGER TRIGGER_FACTURA
BEFORE INSERT ON FACTURA
FOR EACH ROW
BEGIN
SELECT SEQUENCE_FACTURA.NEXTVAL INTO :NEW.CODIGO_FACTURA FROM DUAL;
END;
/

Disparador para el id incremental de la tabla usuario:
CREATE OR REPLACE TRIGGER TRIGGER_USUARIO
BEFORE INSERT ON USUARIO
FOR EACH ROW
BEGIN
SELECT SEQUENCE_USUARIO.NEXTVAL INTO :NEW.ID FROM DUAL;
END;
Disparador para generar la fecha actual de manera automática en la tabla factura:

CREATE OR REPLACE TRIGGER TRIGGER_INSERT_FECHA
BEFORE INSERT ON FACTURA
FOR EACH ROW
BEGIN
    :NEW.FECHA_REALIZADA := SYSDATE;
END;
/

Disparador para validar que el valor_unidad de la tabla producto_factura sea > a 0:

CREATE OR REPLACE TRIGGER VALVALORUNIDAD
BEFORE INSERT OR UPDATE ON PRODUCTO_FACTURA
FOR EACH ROW
BEGIN
IF :NEW.VALOR_POR_UNIDAD < 0 
THEN 
DBMS_OUTPUT.PUT_LINE('VALOR DE LA UNIDAD MENOR QUE 0');
RAISE_APPLICATION_ERROR(-1,'EL VALOR POR UNIDAD ES DE '||:NEW.VALOR_POR_UNIDAD||'Y SOLO SE PERMITEN VALORES DE UNIDAD MAYOR A CERO');
END IF;
END;
/

Disparador para validar que el valor_compra de la tabla producto sea > a 0:

CREATE OR REPLACE TRIGGER VALVALORCOMPRA
BEFORE INSERT OR UPDATE ON PRODUCTO
FOR EACH ROW
BEGIN
IF :NEW.VALOR_COMPRA < 0 
THEN 
DBMS_OUTPUT.PUT_LINE('VALOR DE LA COMPRA MENOR QUE 0');
RAISE_APPLICATION_ERROR(-1,'EL VALOR POR COMPRA ES DE '||:NEW.VALOR_COMPRA||'Y SOLO SE PERMITEN VALORES DE COMPRA MAYOR A CERO');
END IF;
END;
/

Disparador para validar que la cantidad de productos comprados de la tabla producto_factura sea > a 0:

CREATE OR REPLACE TRIGGER VALCANPRODUCTOSCOMPRADOS
BEFORE INSERT OR UPDATE ON PRODUCTO_FACTURA
FOR EACH ROW
BEGIN
IF :NEW.CANPRODUCTOS_COMPRADOS < 0 
THEN 
DBMS_OUTPUT.PUT_LINE('CANTIDAD DE PRODUCTOS MENOR QUE 0');
RAISE_APPLICATION_ERROR(-1,'CANTIDAD DE PRODUCTOS ES DE '||:NEW.CANPRODUCTOS_COMPRADOS||'Y SOLO SE PERMITEN VALORES DE PRODUCTOS COMPRADOS MAYORES A CERO');
END IF;
END;
/

Auditoria para la tabla producto_factura

1. CREATE TABLE AUDITORIA(
ID VARCHAR(19) CONSTRAINT AUD_ID_PK PRIMARY KEY,
DESCRIPCION VARCHAR(300) CONSTRAINT AUD_DESC_NN NOT NULL,
FECHA DATE CONSTRAINT AUD_FECHA_NN NOT NULL);


2. create sequence seq_auditoria;

3.CREATE OR REPLACE PROCEDURE INCLUIR_AUDITORIA
(R_AUDITORIA AUDITORIA%ROWTYPE)
IS
BEGIN
INSERT INTO AUDITORIA
VALUES R_AUDITORIA;
END;
/
4. CREATE OR REPLACE TRIGGER AUD_PROFAC
AFTER INSERT OR UPDATE ON PRODUCTO_FACTURA
FOR EACH ROW
DECLARE
R_AUDITORIA AUDITORIA%ROWTYPE;
BEGIN
SELECT SEQ_AUDITORIA.NEXTVAL INTO R_AUDITORIA.ID
FROM DUAL;
IF INSERTING THEN
R_AUDITORIA.DESCRIPCION:='SE INCLUYO EL PRODUCTOFACTURA CON ID'||:NEW.ID||',DEL CODIGO FACTURA:
'||:NEW.CODIGO_FACTURA||',Y CODIGO DE PRODUCTO:'||:NEW.CODIGO_PRODUCTO;
R_AUDITORIA.FECHA := SYSDATE;

ELSE
R_AUDITORIA.DESCRIPCION:='SE MODIFICO EL PRODUCTOFACTURA CON ID'||:NEW.ID||'DEL CODIGO FACTURA:
'||:NEW.CODIGO_FACTURA||'Y CODIGO DE PRODUCTO:'||:NEW.CODIGO_PRODUCTO;
R_AUDITORIA.FECHA := SYSDATE;
END IF;
INCLUIR_AUDITORIA(R_AUDITORIA);
END;
/
